<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agente de Orçamentação – PDI & Consultoria Ambiental</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121935; --muted:#8ea0ff; --text:#eaf0ff; --accent:#5ee6a8; --danger:#ff6b6b;
      --line:#1f2750; --chip:#1a2147; --yellow:#ffd166;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -10%,#1b2450,transparent),linear-gradient(180deg,#0a0f1f,#060912);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--muted)}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#6ea8ff, #7ef0bf);box-shadow:0 6px 16px rgba(126,240,191,.35), inset 0 0 24px rgba(255,255,255,.35)}
    h1{font-size:clamp(22px,4vw,28px);margin:0}
    .subtitle{opacity:.8;margin-top:4px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .panel h2{font-size:18px;margin:0 0 8px}
    .row{display:grid;grid-template-columns:1fr 130px;gap:10px;align-items:end;margin:10px 0}
    .row > label{display:flex;flex-direction:column;font-size:13px;gap:6px}
    .row input[type="number"], .row input[type="text"]{appearance:textfield;width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0e1530;color:var(--text)}
    input[type="range"]{width:100%}
    .hint{font-size:12px;opacity:.8}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--line);padding:8px 10px;border-radius:999px;font-size:12px}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:10px}
    .kpi .card{background:#0e1530;border:1px solid var(--line);border-radius:14px;padding:12px}
    .kpi .val{font-weight:700;font-size:20px}
    .total{font-size:28px;font-weight:800;color:var(--accent)}
    .muted{opacity:.8}
    .explain{background:#0f1838;border:1px dashed #2b3570;padding:14px;border-radius:12px;font-size:13px;line-height:1.5}
    .btn{cursor:pointer;border:1px solid var(--line);background:#0f1634;color:var(--text);padding:10px 14px;border-radius:12px}
    .btn:hover{background:#101a42}
    .btn.primary{background:linear-gradient(135deg,#6ea8ff,#7ef0bf);color:#061326;border:none}
    details{background:#0d1430;border:1px solid var(--line);border-radius:12px;padding:10px}
    summary{cursor:pointer}
    .stack{display:flex;flex-wrap:wrap;gap:8px}
    .footer{opacity:.7;margin-top:18px;font-size:12px}
    .warn{color:var(--yellow);font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Agente de Orçamentação – PDI & Consultoria Ambiental</h1>
        <div class="subtitle">Explique, simule e justifique seu orçamento em minutos – com raciocínio transparente.</div>
      </div>
    </header>

    <div class="grid">
      <!-- COLUNA ESQUERDA: ENTRADAS -->
      <section class="panel" aria-labelledby="inputs-title">
        <h2 id="inputs-title">1) Configurações do Projeto</h2>

        <div class="row">
          <label>
            Escopo (opcional)
            <input type="text" id="escopo" placeholder="Ex.: Revisão de relatório e dados espaciais (geotecnologia)" value="Revisão de relatório e dados espaciais (geotecnologia)">
            <span class="hint">Use para personalizar a justificativa textual.</span>
          </label>
        </div>

        <div class="row">
          <label>
            Horas Técnicas (HH)
            <input type="number" id="hh" min="1" step="1" value="1470">
            <span class="hint">Dica: ajuste pelo slider abaixo ou digite.</span>
          </label>
          <div>
            <input type="range" id="hhRange" min="10" max="4000" step="10" value="1470" aria-label="Ajustar HH"> 
            <div class="hint" style="text-align:right">10 – 4.000 HH</div>
          </div>
        </div>

        <div class="row">
          <label>
            Tarifa Base por Hora (R$/HH)
            <input type="number" id="rate" min="1" step="0.01" value="85">
            <span class="hint">Custo direto da hora técnica (sem encargos/tributos).</span>
          </label>
          <div class="stack">
            <button class="btn pill" data-preset-rate="75">R$ 75</button>
            <button class="btn pill" data-preset-rate="85">R$ 85</button>
            <button class="btn pill" data-preset-rate="95">R$ 95</button>
            <button class="btn pill" data-preset-rate="110">R$ 110</button>
          </div>
        </div>

        <details id="avancado">
          <summary>Avançado: composição de indiretos (encargos, admin, tributos, lucro)</summary>
          <div class="row">
            <label>Encargos & Benefícios (%)
              <input type="number" id="pEncargos" min="0" step="0.01" value="15">
            </label>
            <label>Administração (%)
              <input type="number" id="pAdmin" min="0" step="0.01" value="8">
            </label>
          </div>
          <div class="row">
            <label>Tributos sobre Receita (%)
              <input type="number" id="pTributos" min="0" step="0.01" value="3.30">
            </label>
            <label>Margem/Lucro (%)
              <input type="number" id="pLucro" min="0" step="0.01" value="0.9970708283">
            </label>
          </div>
          <div class="row">
            <label>Despesas Extras (R$)
              <input type="number" id="extras" min="0" step="0.01" value="0">
            </label>
            <div>
              <span class="pill">Markup total: <span id="markupLabel">27,30%</span></span>
            </div>
          </div>
        </details>

        <div class="stack" style="margin-top:10px">
          <button class="btn" id="preset1470">Preset de verificação: 1470 HH ⇒ R$ 159.057,69</button>
          <button class="btn" id="limpar">Limpar extras / reset</button>
        </div>
      </section>

      <!-- COLUNA DIREITA: RESULTADOS -->
      <section class="panel" aria-labelledby="outputs-title">
        <h2 id="outputs-title">2) Resultado & Justificativa</h2>

        <div class="kpi">
          <div class="card">
            <div class="muted">Custo Direto</div>
            <div class="val" id="kpiDireto">R$ 0,00</div>
            <div class="hint">HH × Tarifa Base</div>
          </div>
          <div class="card">
            <div class="muted">Indiretos & Encargos</div>
            <div class="val" id="kpiIndiretos">R$ 0,00</div>
            <div class="hint">Aplicado sobre o custo direto</div>
          </div>
          <div class="card">
            <div class="muted">Total</div>
            <div class="val total" id="kpiTotal">R$ 0,00</div>
            <div class="hint">Inclui extras e tributos</div>
          </div>
        </div>

        <div class="explain" id="explicacao" style="margin-top:12px"></div>

        <details style="margin-top:12px">
          <summary>Ver fórmula detalhada</summary>
          <pre id="formula" style="white-space:pre-wrap;line-height:1.6"></pre>
        </details>

        <div class="stack" style="margin-top:12px">
          <button class="btn primary" id="copiarJust">Copiar justificativa</button>
          <button class="btn" id="copiarPlanilha">Copiar linha (CSV)</button>
        </div>

        <div class="footer">Nota: os percentuais são editáveis para refletir políticas internas (Simples/Presumido, BDI, etc.). O objetivo é garantir <span class="warn">transparência do raciocínio</span> para PDI e consultoria ambiental.</div>
      </section>
    </div>
  </div>

  <script>
    const R$ = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    const P = new Intl.NumberFormat('pt-BR',{maximumFractionDigits:2});

    // ELEMENTOS
    const el = id=>document.getElementById(id);
    const hh = el('hh');
    const hhRange = el('hhRange');
    const rate = el('rate');
    const pEnc = el('pEncargos');
    const pAdm = el('pAdmin');
    const pTrib = el('pTributos');
    const pLuc = el('pLucro');
    const extras = el('extras');
    const escopo = el('escopo');

    const kpiDireto = el('kpiDireto');
    const kpiInd = el('kpiIndiretos');
    const kpiTotal = el('kpiTotal');
    const explicacao = el('explicacao');
    const formula = el('formula');
    const markupLabel = el('markupLabel');

    function sumMarkup(){
      const s = [pEnc.value, pAdm.value, pTrib.value, pLuc.value]
        .map(v=>parseFloat(v||0)).reduce((a,b)=>a+b,0);
      markupLabel.textContent = P.format(s).replace('.',',')+ '%';
      return s/100;
    }

    function calc(){
      const HH = parseFloat(hh.value||0);
      const RATE = parseFloat(rate.value||0);
      const M = sumMarkup();
      const EX = parseFloat(extras.value||0);

      const direto = HH*RATE; // custo direto
      const indiretos = direto*M; // bdi sobre direto
      const total = direto + indiretos + EX;

      // KPIs visuais
      kpiDireto.textContent = R$.format(direto);
      kpiInd.textContent = R$.format(indiretos);
      kpiTotal.textContent = R$.format(total);

      // Explicação natural
      const texto = `Estimativa para ${HH} HH em \"${escopo.value || 'escopo não informado'}\".
Tarifa base de ${R$.format(RATE)} (custo direto).
Aplicado markup total de ${P.format(M*100).replace('.',',')}% (encargos, administração, tributos e margem),
mais despesas extras de ${R$.format(EX)}.
Resultado: ${R$.format(total)}.`;
      explicacao.textContent = texto;

      // Fórmula
      const f = [
        `Custo direto = HH × Tarifa = ${HH} × ${R$.format(RATE)} = ${R$.format(direto)}`,
        `Markup (indiretos) = Custo direto × (${P.format(M*100).replace('.',',')}%) = ${R$.format(indiretos)}`,
        `Total = Custo direto + Indiretos + Extras = ${R$.format(direto)} + ${R$.format(indiretos)} + ${R$.format(EX)} = ${R$.format(total)}`
      ].join('\n');
      formula.textContent = f;

      return {HH, RATE, M, EX, direto, indiretos, total}
    }

    function setRatePreset(v){ rate.value = v; calc(); }

    // vínculos
    [hh, hhRange, rate, pEnc, pAdm, pTrib, pLuc, extras, escopo].forEach(e=>{
      e.addEventListener('input', e=>{
        if(e.target===hh) hhRange.value = hh.value;
        if(e.target===hhRange) hh.value = hhRange.value;
        calc();
      })
    });

    // presets de tarifa
    document.querySelectorAll('[data-preset-rate]').forEach(btn=>{
      btn.addEventListener('click',()=>setRatePreset(btn.dataset.presetRate))
    });

    // Botões auxiliares
    el('limpar').addEventListener('click',()=>{
      extras.value = 0;
      // mantém percentuais atuais
      calc();
    });

    el('preset1470').addEventListener('click',()=>{
      hh.value = 1470; hhRange.value = 1470; rate.value = 85; 
      // Para fechar exatamente R$ 159.057,69, garantimos o markup total = 27,2970708283%
      pEnc.value = 15; pAdm.value = 8; pTrib.value = 3.30; pLuc.value = 0.9970708283; // soma exata
      extras.value = 0;
      calc();
      // checagem de consistência (tolerância de centavos)
      const { total } = calc();
      const alvo = 159057.69;
      const diff = Math.abs(total - alvo);
      if(diff > 0.02){
        console.warn('Diferença acima de 2 centavos da meta de verificação:', diff);
      }
    });

    // copiar justificativa
    el('copiarJust').addEventListener('click',()=>{
      const {HH, RATE, M, EX, total} = calc();
      const texto = `Justificativa de Orçamento – ${escopo.value||'Projeto'}\n\n`+
        `Foram estimadas ${HH} horas técnicas (HH) à tarifa base de ${R$.format(RATE)} por hora. `+
        `Aplicou-se um markup total de ${(M*100).toFixed(4).replace('.',',')}% (encargos, administração, tributos e margem) sobre o custo direto, `+
        `além de despesas extras de ${R$.format(EX)} quando aplicável. `+
        `O valor total do serviço é ${R$.format(total)}.`;
      navigator.clipboard.writeText(texto);
      alert('Justificativa copiada para a área de transferência.');
    });

    // copiar linha CSV
    el('copiarPlanilha').addEventListener('click',()=>{
      const {HH, RATE, M, EX, direto, indiretos, total} = calc();
      const linha = [
        'Escopo', 'HH', 'TarifaBase_R$/HH', 'Markup_%', 'Extras_R$', 'CustoDireto_R$', 'Indiretos_R$', 'Total_R$' 
      ].join(';')+"\n"+
      [
        (escopo.value||'Projeto'), HH, RATE.toFixed(2).replace('.',','), (M*100).toFixed(6).replace('.',','), EX.toFixed(2).replace('.',','),
        direto.toFixed(2).replace('.',','), indiretos.toFixed(2).replace('.',','), total.toFixed(2).replace('.',',')
      ].join(';');
      navigator.clipboard.writeText(linha);
      alert('Linha (CSV) copiada. Cole na sua planilha.');
    });

    // inicialização
    el('preset1470').click();
  </script>
</body>
</html>
